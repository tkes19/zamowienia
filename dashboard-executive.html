<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centrum Produkcji - Dashboard Szefa | REZON</title>
    <link rel="stylesheet" href="assets/tailwind.generated.css">
    <link rel="stylesheet" href="assets/vendor/fontawesome/all.min.css">
    <link rel="stylesheet" href="assets/styles.css">
    <style>
        /* Executive Dashboard Styles */
        :root {
            --exec-bg: #f8fafc;
            --exec-card: #ffffff;
            --exec-border: #e2e8f0;
            --exec-text: #1e293b;
            --exec-text-muted: #64748b;
            --exec-primary: #3b82f6;
            --exec-success: #22c55e;
            --exec-warning: #f59e0b;
            --exec-danger: #ef4444;
        }

        body {
            background: var(--exec-bg);
            color: var(--exec-text);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        /* Sticky Header with Navigation */
        .exec-header {
            background: var(--exec-card);
            border-bottom: 1px solid var(--exec-border);
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        /* KPI Tiles */
        .kpi-tile {
            background: var(--exec-card);
            border: 1px solid var(--exec-border);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.2s ease;
        }

        .kpi-tile:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transform: translateY(-2px);
        }

        .kpi-value {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1;
        }

        .kpi-label {
            font-size: 0.875rem;
            color: var(--exec-text-muted);
            margin-top: 0.5rem;
        }

        /* Status Indicators */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-critical {
            background: #fef2f2;
            color: var(--exec-danger);
        }

        .status-high {
            background: #fef3c7;
            color: var(--exec-warning);
        }

        .status-normal {
            background: #f0fdf4;
            color: var(--exec-success);
        }

        /* Heatmap */
        .heatmap-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .heatmap-cell:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .heatmap-low { background: #dcfce7; color: #166534; }
        .heatmap-medium { background: #fef3c7; color: #92400e; }
        .heatmap-high { background: #fed7aa; color: #9a3412; }
        .heatmap-critical { background: #fecaca; color: #991b1b; }

        /* Action Items */
        .action-item {
            background: var(--exec-card);
            border: 1px solid var(--exec-border);
            border-radius: 8px;
            padding: 1rem;
            transition: all 0.2s ease;
        }

        .action-item:hover {
            border-color: var(--exec-primary);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
        }

        /* Risk Table */
        .risk-table {
            background: var(--exec-card);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .risk-table th {
            background: #f8fafc;
            font-weight: 600;
            text-align: left;
            font-size: 0.875rem;
            color: var(--exec-text-muted);
        }

        .risk-table td {
            padding: 1rem;
            border-top: 1px solid var(--exec-border);
        }

        /* Loading State */
        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .kpi-value { font-size: 2rem; }
            .exec-grid-cols-3 { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 640px) {
            .kpi-value { font-size: 1.5rem; }
            .exec-grid-cols-3 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Sticky Header with Navigation -->
    <header class="exec-header">
        <div class="px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Left: Back Button + Title -->
                <div class="flex items-center gap-4">
                    <button id="backButton" class="p-2 hover:bg-gray-100 rounded-lg transition-colors" title="Powrót">
                        <i class="fas fa-arrow-left text-gray-600"></i>
                    </button>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">Centrum Produkcji</h1>
                        <p class="text-sm text-gray-500">Panel Kierowniczy Produkcji</p>
                    </div>
                </div>

                <!-- Center: Quick Switch -->
                <div class="hidden md:flex items-center gap-2">
                    <label class="text-sm text-gray-500">Szybki przełącz:</label>
                    <select id="quickSwitch" class="text-sm border rounded-lg px-3 py-1.5">
                        <option value="dashboard" selected>Centrum Produkcji</option>
                        <option value="admin">Panel Admina</option>
                        <option value="production">Produkcja</option>
                    </select>
                </div>

                <!-- Right: Actions -->
                <div class="flex items-center gap-3">
                    <button id="refreshButton" class="p-2 hover:bg-gray-100 rounded-lg transition-colors" title="Odśwież">
                        <i class="fas fa-sync-alt text-gray-600"></i>
                    </button>
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="text-sm text-gray-500">Live</span>
                    </div>
                    <span id="lastUpdate" class="text-sm text-gray-500">--:--</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="px-4 sm:px-6 lg:px-8 py-6 max-w-7xl mx-auto">
        <!-- KPI Section -->
        <section class="mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Risk KPI -->
                <div class="kpi-tile">
                    <div class="flex items-start justify-between">
                        <div>
                            <div id="riskCount" class="kpi-value text-red-600">-</div>
                            <div class="kpi-label">Ryzyka aktywne</div>
                        </div>
                        <div class="status-indicator status-critical">
                            <i class="fas fa-exclamation-triangle text-xs"></i>
                            Krytyczne
                        </div>
                    </div>
                </div>

                <!-- Machines Down KPI -->
                <div class="kpi-tile">
                    <div class="flex items-start justify-between">
                        <div>
                            <div id="machinesDown" class="kpi-value text-orange-600">-</div>
                            <div class="kpi-label">Maszyny w awarii</div>
                        </div>
                        <div class="status-indicator status-high">
                            <i class="fas fa-tools text-xs"></i>
                            Uwaga
                        </div>
                    </div>
                </div>

                <!-- Material Shortages KPI -->
                <div class="kpi-tile">
                    <div class="flex items-start justify-between">
                        <div>
                            <div id="materialShortages" class="kpi-value text-yellow-600">-</div>
                            <div class="kpi-label">Braki materiałowe</div>
                        </div>
                        <div class="status-indicator status-high">
                            <i class="fas fa-boxes text-xs"></i>
                            Dostawa
                        </div>
                    </div>
                </div>

                <!-- Throughput KPI -->
                <div class="kpi-tile">
                    <div class="flex items-start justify-between">
                        <div>
                            <div id="throughputToday" class="kpi-value text-green-600">-</div>
                            <div class="kpi-label">Przepustowość dziś</div>
                        </div>
                        <div class="status-indicator status-normal">
                            <i class="fas fa-chart-line text-xs"></i>
                            OK
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Main Grid: Heatmap + Actions -->
        <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Heatmap -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg border p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-gray-900">Mapa obciążenia (7 dni)</h2>
                        <div class="flex items-center gap-4 text-xs">
                            <span class="flex items-center gap-1">
                                <div class="w-3 h-3 heatmap-low rounded"></div> Niski
                            </span>
                            <span class="flex items-center gap-1">
                                <div class="w-3 h-3 heatmap-medium rounded"></div> Średni
                            </span>
                            <span class="flex items-center gap-1">
                                <div class="w-3 h-3 heatmap-high rounded"></div> Wysoki
                            </span>
                            <span class="flex items-center gap-1">
                                <div class="w-3 h-3 heatmap-critical rounded"></div> Krytyczny
                            </span>
                        </div>
                    </div>
                    <div id="heatmapContainer" class="loading-skeleton h-64 rounded"></div>
                </div>
            </div>

            <!-- Actions -->
            <div>
                <div class="bg-white rounded-lg border p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold">Akcje do podjęcia</h2>
                        <span class="text-xs text-gray-500">Top 5</span>
                    </div>
                    <div id="actionsContainer" class="space-y-3">
                        <!-- Actions will be loaded here -->
                    </div>
                </div>
            </div>
        </section>

        <!-- At Risk Orders Table -->
        <section>
            <div class="risk-table">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold">Zagrożone zamówienia</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr>
                                <th class="px-6 py-3">Numer</th>
                                <th class="px-6 py-3">Klient</th>
                                <th class="px-6 py-3">Ryzyko</th>
                                <th class="px-6 py-3">Powód</th>
                                <th class="px-6 py-3">Dni do terminu</th>
                                <th class="px-6 py-3">Akcje</th>
                            </tr>
                        </thead>
                        <tbody id="risksTableBody">
                            <!-- Risks will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <!-- Modals -->
    <!-- Risk Details Modal -->
    <div id="riskModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-auto">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold">Szczegóły ryzyka</h3>
                        <button onclick="closeModal('riskModal')" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div id="riskModalContent">
                        <!-- Content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Confirmation Modal -->
    <div id="actionModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-md w-full">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold">Potwierdź akcję</h3>
                        <button onclick="closeModal('actionModal')" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <p id="actionModalDescription" class="text-gray-600 mb-6"></p>
                    <div class="flex gap-3 justify-end">
                        <button onclick="closeModal('actionModal')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">
                            Anuluj
                        </button>
                        <button id="confirmActionButton" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Wykonaj
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Executive Dashboard JavaScript
        let dashboardData = null;
        let refreshInterval = null;
        let eventSource = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            setupEventListeners();
            await loadDashboard();
            startAutoRefresh();
            connectSSE();
        });

        // Check authentication and role
        async function checkAuth() {
            try {
                // Use relative URL since env.js might not be loaded yet
                const response = await fetch('/api/auth/me', { credentials: 'include' });
                if (!response.ok) {
                    console.error('Auth response not ok:', response.status);
                    window.location.href = '/login';
                    return;
                }
                const result = await response.json();
                if (!result || result.status !== 'success') {
                    console.error('Auth response invalid:', result);
                    window.location.href = '/login';
                    return;
                }
                const user = result.user || result;
                const role = result.role || user?.role;
                console.log('User role:', role);
                if (!['ADMIN', 'PRODUCTION_MANAGER'].includes(role)) {
                    alert('Brak dostępu do tego dashboardu');
                    window.history.back();
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '/login';
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Back button
            document.getElementById('backButton').addEventListener('click', () => {
                const referrer = document.referrer;
                if (referrer.includes('admin') || referrer.includes('production')) {
                    window.history.back();
                } else {
                    // Default to admin
                    window.location.href = 'admin/index.html';
                }
            });

            // Quick switch
            document.getElementById('quickSwitch').addEventListener('change', (e) => {
                switch(e.target.value) {
                    case 'admin':
                        window.location.href = 'admin/index.html';
                        break;
                    case 'production':
                        window.location.href = 'production.html';
                        break;
                }
            });

            // Refresh button
            document.getElementById('refreshButton').addEventListener('click', () => {
                loadDashboard();
            });
        }

        // Load dashboard data
        async function loadDashboard() {
            try {
                console.log('Loading dashboard data...');
                const [dashboardResponse, risksResponse] = await Promise.all([
                    fetch('/api/production/dashboard/executive', { credentials: 'include' }),
                    fetch('/api/production/risks', { credentials: 'include' })
                ]);

                if (!dashboardResponse.ok || !risksResponse.ok) {
                    throw new Error('Failed to fetch dashboard data');
                }

                const dashboard = await dashboardResponse.json();
                const risks = await risksResponse.json();

                console.log('Dashboard data:', dashboard);
                console.log('Risks data:', risks);

                if (dashboard.success && risks.success) {
                    dashboardData = dashboard.data;
                    renderDashboard(dashboard.data, risks.data);
                    updateLastUpdate();
                } else {
                    throw new Error(dashboard.message || risks.message || 'Unknown error');
                }
            } catch (error) {
                console.error('Failed to load dashboard:', error);
                showError('Nie udało się załadować danych dashboardu');
            }
        }

        // Render dashboard
        function renderDashboard(data, risks) {
            // Update KPIs
            document.getElementById('riskCount').textContent = data.summary.atRiskOrders;
            document.getElementById('machinesDown').textContent = data.summary.machinesDown;
            document.getElementById('materialShortages').textContent = data.summary.materialShortages;
            document.getElementById('throughputToday').textContent = data.kpi.throughputToday;

            // Render heatmap
            renderHeatmap(data.trends);

            // Render actions
            renderActions(data.actions);

            // Render risks table
            renderRisksTable(risks);
        }

        // Render heatmap (placeholder)
        function renderHeatmap(trends) {
            const container = document.getElementById('heatmapContainer');
            container.classList.remove('loading-skeleton');
            
            // Check if we have real trend data
            if (trends && trends.heatmap && trends.heatmap.length > 0) {
                // Render real heatmap data
                const heatmapData = trends.heatmap;
                let html = '<div class="grid grid-cols-8 gap-2">';
                html += '<div></div>';
                ['Pon', 'Wt', 'Śr', 'Czw', 'Pt', 'Sob', 'Nie'].forEach(day => {
                    html += `<div class="text-xs text-center font-medium">${day}</div>`;
                });
                
                heatmapData.forEach(row => {
                    html += `<div class="text-xs font-medium pr-2">${row.room}</div>`;
                    row.days.forEach(day => {
                        // Use utilization to determine color intensity
                        const utilization = day.utilization || 0;
                        const orders = day.orders || 0;
                        let level = 'low';
                        if (day.status === 'down') {
                            level = 'critical';
                        } else if (utilization > 80) {
                            level = 'critical';
                        } else if (utilization > 60) {
                            level = 'high';
                        } else if (utilization > 40) {
                            level = 'medium';
                        }
                        
                        // Show orders count, or 'X' if machine is down
                        const displayText = day.status === 'down' ? '✕' : orders;
                        const tooltip = day.status === 'down' 
                            ? `${row.room} - Maszyna wyłączona`
                            : `${row.room} - ${orders} zleceń, ${utilization}% wykorzystania`;
                        
                        html += `<div class="heatmap-cell heatmap-${level}" title="${tooltip}">${displayText}</div>`;
                    });
                });
                
                html += '</div>';
                container.innerHTML = html;
                
                // Add legend
                const legend = `
                    <div class="flex items-center justify-center gap-4 mt-4 text-xs text-gray-600">
                        <span class="flex items-center gap-1">
                            <div class="w-3 h-3 heatmap-low border rounded"></div> Niskie
                        </span>
                        <span class="flex items-center gap-1">
                            <div class="w-3 h-3 heatmap-medium border rounded"></div> Średnie
                        </span>
                        <span class="flex items-center gap-1">
                            <div class="w-3 h-3 heatmap-high border rounded"></div> Wysokie
                        </span>
                        <span class="flex items-center gap-1">
                            <div class="w-3 h-3 heatmap-critical border rounded"></div> Krytyczne
                        </span>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', legend);
                
            } else {
                // Show a clean placeholder with no random data
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-chart-area text-4xl mb-4 opacity-50"></i>
                        <p class="text-sm">Dane o obciążeniu będą dostępne po zebraniu statystyk</p>
                        <p class="text-xs mt-2">Heatmapa pokaże obciążenie maszyn w ostatnich 7 dniach</p>
                        <div class="flex items-center justify-center gap-4 mt-4 text-xs text-gray-400">
                            <span class="flex items-center gap-1">
                                <div class="w-3 h-3 heatmap-low border rounded"></div> Niskie
                            </span>
                            <span class="flex items-center gap-1">
                                <div class="w-3 h-3 heatmap-medium border rounded"></div> Średnie
                            </span>
                            <span class="flex items-center gap-1">
                                <div class="w-3 h-3 heatmap-high border rounded"></div> Wysokie
                            </span>
                            <span class="flex items-center gap-1">
                                <div class="w-3 h-3 heatmap-critical border rounded"></div> Krytyczne
                            </span>
                        </div>
                    </div>
                `;
            }
        }

        // Render actions
        function renderActions(actions) {
            const container = document.getElementById('actionsContainer');
            
            if (actions.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Brak akcji do podjęcia</p>';
                return;
            }

            container.innerHTML = actions.slice(0, 5).map(action => `
                <div class="action-item">
                    <div class="flex items-start justify-between mb-2">
                        <h4 class="font-medium text-sm">${action.title}</h4>
                        <span class="status-indicator ${action.priority === 'high' ? 'status-critical' : 'status-high'} text-xs">
                            ${action.priority === 'high' ? 'Wysoki' : 'Średni'}
                        </span>
                    </div>
                    <p class="text-xs text-gray-600 mb-2">${action.description}</p>
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-500">Wpływ: ${action.impact}</span>
                        <button onclick="executeAction('${action.type}', ${JSON.stringify(action.action).replace(/"/g, '&quot;')})" 
                                class="text-xs px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">
                            Wykonaj
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Render risks table
        function renderRisksTable(risks) {
            const tbody = document.getElementById('risksTableBody');
            
            if (risks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">Brak ryzyk</td></tr>';
                return;
            }

            tbody.innerHTML = risks.slice(0, 10).map(risk => `
                <tr class="hover:bg-gray-50">
                    <td class="font-medium">${risk.title}</td>
                    <td>${risk.location}</td>
                    <td>
                        <span class="status-indicator ${risk.severity === 'critical' ? 'status-critical' : 'status-high'}">
                            ${risk.severity === 'critical' ? 'Krytyczne' : 'Wysokie'}
                        </span>
                    </td>
                    <td class="text-sm text-gray-600">${risk.description}</td>
                    <td class="text-sm">${new Date(risk.detectedAt).toLocaleDateString('pl-PL')}</td>
                    <td>
                        <button onclick="showRiskDetails('${risk.id}')" class="text-blue-600 hover:text-blue-800 text-sm">
                            Szczegóły
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Execute action
        function executeAction(type, action) {
            document.getElementById('actionModalDescription').textContent = 
                `Czy na pewno chcesz wykonać: ${action.endpoint}?`;
            document.getElementById('actionModal').classList.remove('hidden');
            
            document.getElementById('confirmActionButton').onclick = async () => {
                try {
                    const response = await fetch(`${window.env.API_URL}${action.endpoint}`, {
                        method: action.method || 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: action.data ? JSON.stringify(action.data) : undefined
                    });
                    
                    if (response.ok) {
                        closeModal('actionModal');
                        await loadDashboard(); // Refresh data
                        showSuccess('Akcja wykonana pomyślnie');
                    }
                } catch (error) {
                    console.error('Action failed:', error);
                    showError('Błąd podczas wykonywania akcji');
                }
            };
        }

        // Show risk details
        function showRiskDetails(riskId) {
            // Placeholder implementation
            document.getElementById('riskModalContent').innerHTML = `
                <p>Szczegóły ryzyka ${riskId} będą dostępne wkrótce</p>
            `;
            document.getElementById('riskModal').classList.remove('hidden');
        }

        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // Auto refresh
        function startAutoRefresh() {
            refreshInterval = setInterval(() => {
                loadDashboard();
            }, 30000); // 30 seconds
        }

        // SSE Connection
        function connectSSE() {
            if (eventSource) eventSource.close();
            
            try {
                eventSource = new EventSource('/api/events', {
                    withCredentials: true
                });
                
                eventSource.addEventListener('risk_level_changed', () => {
                    console.log('SSE: risk_level_changed');
                    loadDashboard();
                });
                
                eventSource.addEventListener('machine_status_changed', () => {
                    console.log('SSE: machine_status_changed');
                    loadDashboard();
                });
                
                eventSource.addEventListener('material_shortage', () => {
                    console.log('SSE: material_shortage');
                    loadDashboard();
                });
                
                eventSource.onerror = () => {
                    console.error('SSE connection error');
                    setTimeout(connectSSE, 5000);
                };
            } catch (error) {
                console.error('Failed to create SSE connection:', error);
            }
        }

        // Update last update time
        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = 
                now.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });
        }

        // Utility functions
        function showError(message) {
            // Implement toast or alert
            console.error(message);
        }

        function showSuccess(message) {
            // Implement toast or alert
            console.log(message);
        }

        // Cleanup
        window.addEventListener('beforeunload', () => {
            if (refreshInterval) clearInterval(refreshInterval);
            if (eventSource) eventSource.close();
        });
    </script>
</body>
</html>
